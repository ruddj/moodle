define(["jquery","core/log","core/str","core/templates","core/notification"],function(a,b,c,d,e){var f={DOWN:40,ENTER:13,SPACE:32,ESCAPE:27,COMMA:188,UP:38},g=null,h=function(b,c){var d=a(document.getElementById(c)),e=d.children("[aria-selected=true]").length;for(b%=e;0>b;)b+=e;var f=a(d.children("[aria-selected=true]").get(b)),g=c+"-"+b;d.children().attr("data-active-selection",!1).attr("id",""),f.attr("data-active-selection",!0).attr("id",g),d.attr("aria-activedescendant",g)},i=function(b,c,d,e,f){var g=a(d).attr("data-value");f&&e.children("option").each(function(b,c){a(c).attr("value")==g&&(a(c).prop("selected",!1),a(c).attr("data-iscustom")&&a(c).remove())}),r(c,b,e,f)},j=function(b,c,d){var e=a(document.getElementById(c)),f=a(document.getElementById(d)),g=f.children("[aria-hidden=false]").length;for(b%=g;0>b;)b+=g;var h=a(f.children("[aria-hidden=false]").get(b)),i=a(f.children("[role=option]")).index(h),j=d+"-"+i;f.children().attr("aria-selected",!1).attr("id",""),h.attr("aria-selected",!0).attr("id",j),e.attr("aria-activedescendant",j);var k=h.offset().top-f.offset().top+f.scrollTop()-f.height()/2;f.animate({scrollTop:k},100)},k=function(b,c){var d=a(document.getElementById(c)),e=d.children("[aria-selected=true]"),f=d.children("[aria-hidden=false]").index(e);j(f+1,b,c)},l=function(b){var c=a(document.getElementById(b)),d=c.children("[data-active-selection=true]");if(!d)return void h(0,b);var e=c.children("[aria-selected=true]").index(d);h(e-1,b)},m=function(b){var c=a(document.getElementById(b)),d=c.children("[data-active-selection=true]");if(!d)return void h(0,b);var e=c.children("[aria-selected=true]").index(d);h(e+1,b)},n=function(b,c){var d=a(document.getElementById(c)),e=d.children("[aria-selected=true]"),f=d.children("[aria-hidden=false]").index(e);j(f-1,b,c)},o=function(b,c,d){var e=a(document.getElementById(b)),f=a(document.getElementById(c));e.attr("aria-expanded",!1).attr("aria-activedescendant",d),f.hide().attr("aria-hidden",!0)},p=function(b,f,g,h,i,k,l){var m=a(document.getElementById(f)),n=a(document.getElementById(g)),o=!1,p=[];h.children("option").each(function(b,c){a(c).prop("selected")!==!0&&(p[p.length]={label:c.innerHTML,value:a(c).attr("value")})});var q=l?b:b.toLocaleLowerCase();d.render("core/form_autocomplete_suggestions",{inputId:f,suggestionsId:g,options:p,multiple:i}).done(function(b){n.replaceWith(b),n=a(document.getElementById(g)),n.show().attr("aria-hidden",!1),n.children().each(function(b,c){c=a(c),l&&c.text().indexOf(q)>-1||!l&&c.text().toLocaleLowerCase().indexOf(q)>-1?(c.show().attr("aria-hidden",!1),o=!0):c.hide().attr("aria-hidden",!0)}),m.attr("aria-expanded",!0),o?k||j(0,f,g):c.get_string("nosuggestions","form").done(function(a){n.html(a)})}).fail(e.exception)},q=function(b,c,d,e,f){var g=a(document.getElementById(b)),h=g.val(),i=h.split(","),j=!1;a.each(i,function(b,c){if(c=c.trim(),""!==c&&(e||f.children("option").prop("selected",!1),f.children("option").each(function(b,d){a(d).attr("value")==c&&(j=!0,a(d).prop("selected",!0))}),!j)){var d=a("<option>");d.append(c),d.attr("value",c),f.append(d),d.prop("selected",!0),d.attr("data-iscustom",!0)}}),r(d,b,f,e),g.val(""),o(b,c,d)},r=function(b,c,f,g){var i=[],j=a(document.getElementById(b)),k=j.attr("aria-activedescendant"),l=!1;k&&(l=a(document.getElementById(k)).attr("data-value")),f.children("option").each(function(b,c){a(c).prop("selected")&&i.push({label:a(c).html(),value:a(c).attr("value")})});var m={selectionId:b,items:i,multiple:g};d.render("core/form_autocomplete_selection",m).done(function(c){j.empty().append(a(c).html()),l!==!1&&j.children("[aria-selected=true]").each(function(c,d){a(d).attr("data-value")===l&&h(c,b)})}).fail(e.exception),f.change()},s=function(b,c,d,e,f){var g=a(document.getElementById(b)),h=a(document.getElementById(c)),i=h.children("[aria-selected=true]").attr("data-value");e||f.children("option").prop("selected",!1),f.children("option").each(function(b,c){a(c).attr("value")==i&&a(c).prop("selected",!0)}),r(d,b,f,e),g.val(""),o(b,c,d)},t=function(b,c,d,f,g,h,i,j,k){var l=a(b.currentTarget).val();j.transport(c,l,function(b){var e=j.processResults(c,b),l=[];g.children("option").each(function(b,c){c=a(c),c.prop("selected")?l.push(c.attr("value")):c.remove()}),a.each(e,function(b,c){if(-1===l.indexOf(c.value)){var d=a("<option>");d.append(c.label),d.attr("value",c.value),g.append(d)}}),p("",d,f,g,h,i,k)},e.exception)},u=function(b,c,d,e,h,r,u,v,w,x){var y=a(document.getElementById(b));y.on("keydown",function(d){switch(d.keyCode){case f.DOWN:return"true"===y.attr("aria-expanded")?k(b,c):!y.val()&&w?require([w],function(a){t(d,v,b,c,h,r,u,a,x)}):p(y.val(),b,c,h,r,u,x),d.preventDefault(),!1;case f.COMMA:return u&&q(b,c,e,r,h),d.preventDefault(),!1;case f.UP:return n(b,c),d.preventDefault(),!1;case f.ENTER:var g=a(document.getElementById(c));return"true"===y.attr("aria-expanded")&&g.children("[aria-selected=true]").length>0?s(b,c,e,r,h):u&&q(b,c,e,r,h),d.preventDefault(),!1;case f.ESCAPE:return"true"===y.attr("aria-expanded")&&o(b,c,e),d.preventDefault(),!1}return!0}),y.on("behat:set-value",function(){u&&q(b,c,e,r,h)}),y.on("blur focus",function(a){g&&window.clearTimeout(g),g=window.setTimeout(function(){"blur"==a.type&&(u&&q(b,c,e,r,h),o(b,c,e))},500)});var z=a(document.getElementById(d));z.on("click",function(){y.focus(),g&&window.clearTimeout(g),p(y.val(),b,c,h,r,u,x)});var A=a(document.getElementById(c));A.parent().on("click","[role=option]",function(d){var f=a(d.currentTarget).closest("[role=option]"),g=a(document.getElementById(c)),i=g.children("[aria-hidden=false]").index(f);j(i,b,c),s(b,c,e,r,h)});var B=a(document.getElementById(e));B.on("click","[role=listitem]",function(c){var d=a(c.currentTarget);i(b,e,d,h,r)}),B.on("keydown",function(c){switch(c.keyCode){case f.DOWN:return m(e),c.preventDefault(),!1;case f.UP:return l(e),c.preventDefault(),!1;case f.SPACE:case f.ENTER:var d=a(document.getElementById(e)).children("[data-active-selection=true]");return d&&(i(b,e,d,h,r),c.preventDefault()),!1}return!0}),y.on("input",function(d){var e=a(d.currentTarget).val(),f=a(d.currentTarget).data("last-value");"undefined"==typeof f&&(f=e),f!=e&&(p(e,b,c,h,r,u,x),a(d.currentTarget).data("last-value",e))})};return{enhance:function(c,e,f,g,h){"undefined"==typeof e&&(e=!1),"undefined"==typeof f&&(f=!1),"undefined"==typeof h&&(h=!1);var i=a(c);if(!i)return b.debug("Selector not found: "+c),!1;i.hide().attr("aria-hidden",!0);var j=i.attr("id"),k=i.attr("multiple"),l="form_autocomplete_input-"+a.now(),m="form_autocomplete_suggestions-"+a.now(),n="form_autocomplete_selection-"+a.now(),o="form_autocomplete_downarrow-"+a.now(),p=a("[for="+j+"]"),q=[];i.children("option").each(function(b,c){q[b]={label:c.innerHTML,value:a(c).attr("value")}});var s=d.render("core/form_autocomplete_input",{downArrowId:o,inputId:l,suggestionsId:m,selectionId:n,placeholder:g,multiple:k}),v=d.render("core/form_autocomplete_suggestions",{inputId:l,suggestionsId:m,options:q,multiple:k}),w=d.render("core/form_autocomplete_selection",{selectionId:n,items:[],multiple:k});a.when(s,v,w).done(function(b,d,g){i.after(d),i.after(b),i.after(g),p.attr("for",l),u(l,m,o,n,i,k,e,c,f,h);var j=a(document.getElementById(l)),q=a(document.getElementById(m));q.hide().attr("aria-hidden",!0),f&&require([f],function(b){var d=function(a){t(a,c,l,m,i,k,e,b,h)};j.on("input keypress",d);var f=a(document.getElementById(o));f.on("click",d)}),r(n,l,i,k)})}}});